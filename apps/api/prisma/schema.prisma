generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String?
  password                String?
  role                    Role                     @default(USER)
  emailVerified           DateTime?
  image                   String?
  bio                     String?
  reputation              Int                      @default(0)
  isEmailVerified         Boolean                  @default(false)
  emailVerifiedAt         DateTime?
  lastLoginAt             DateTime?
  licenseNumber           String?
  specialization          String[]
  yearsOfExperience       Int?
  organization            String?
  phone                   String?
  location                String?
  website                 String?
  languages               String[]
  education               String?
  certifications          String[]
  lastActive              DateTime?
  verificationStatus      VerificationStatus       @default(PENDING)
  verifiedAt              DateTime?
  embedding               Float[]                  @default([])
  embedding_vector        Unsupported("vector")?
  trustScore              Float                    @default(0)
  emergencyContact        String?
  emergencyPhone          String?
  state                   String?
  city                    String?
  preferredLanguage       String                   @default("en")
  resetPasswordToken      String?                  @unique
  resetPasswordExpiry     DateTime?
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  googleId                String?                  @unique
  acceptedAnswerCount     Int                      @default(0)
  answerCount             Int                      @default(0)
  expertTopics            String[]                 @default([])
  helpfulVoteCount        Int                      @default(0)
  questionCount           Int                      @default(0)
  stripeCustomerId        String?                  @unique
  aiSubscription          AiSubscription?
  aiUsage                 AiUsage?
  answers                 Answer[]                 @relation("AnswerAuthor")
  answerComments          AnswerComment[]          @relation("AnswerComments")
  receivedAnswerRequests  AnswerRequest[]          @relation("ReceivedRequests")
  sentAnswerRequests      AnswerRequest[]          @relation("SentRequests")
  answerViews             AnswerView[]             @relation("AnswerViews")
  answerVotes             AnswerVote[]             @relation("AnswerVotes")
  bookmarks               Bookmark[]
  clinicalConversations   ClinicalConversation[]
  clinicalPlans           ClinicalPlan[]
  clinicalFeedback        ClinicalFeedback[]
  comments                Comment[]
  createdCommunities      Community[]              @relation("CreatedCommunities")
  communityMemberships    CommunityMember[]
  crisisIncidents         CrisisIncident[]
  crisisVolunteer         CrisisVolunteer?
  engagementEvents        EngagementEvent[]
  createdEvents           Event[]                  @relation("EventCreator")
  eventInterests          EventInterest[]
  fcmTokens               FcmToken[]
  feedInteractions        FeedInteraction[]
  followers               Follow[]                 @relation("UserFollowers")
  following               Follow[]                 @relation("UserFollowing")
  moderatedLogs           ModerationLog[]          @relation("ModeratorLogs")
  actionLogs              ModerationLog[]          @relation("UserActionLogs")
  sentNotifications       Notification[]           @relation("NotificationSender")
  notifications           Notification[]
  sentOrganizationInvites OrganizationInvitation[] @relation("SentOrganizationInvites")
  organizationMemberships OrganizationMember[]     @relation("UserOrganizationMemberships")
  posts                   Post[]
  postViews               PostView[]
  questions               Question[]               @relation("QuestionAuthor")
  followedQuestions       QuestionFollower[]       @relation("QuestionFollowers")
  reports                 Report[]
  interactionProfile      UserInteractionProfile?
  userInterests           UserInterests[]
  preferences             UserPreferences?
  similarityTo            UserSimilarity[]         @relation("UserSimilarityTo")
  similarityFrom          UserSimilarity[]         @relation("UserSimilarityFrom")
  verificationDocs        VerificationDoc[]
  votes                   Vote[]
  whatsappGroupsAsAdmin   WhatsAppGroup[]          @relation("WhatsAppGroupAdmin")
  whatsappInvitations     WhatsAppInvitation[]
  sharedAssessments       AssessmentShare[]        @relation("SharedAssessments")
  receivedAssessments     AssessmentShare[]        @relation("ReceivedAssessments")
  patientBookings         Booking[]                @relation("PatientBookings")
  packagePurchases        PackagePurchase[]        @relation("PackagePurchases")
  providerViews           ProviderView[]           @relation("UserProviderViews")
  createdProviders        Provider[]               @relation("ProviderCreator")
  raisedDisputes          SessionDispute[]         @relation("RaisedDisputes")
  resolvedDisputes        SessionDispute[]         @relation("ResolvedDisputes")
  sessionRatings          SessionRating[]          @relation("SessionRatings")
  therapistProfile        TherapistProfile?        @relation("TherapistProfile")
  userProfile             UserProfile?             @relation("UserProfile")
  bannerAds               BannerAd[]

  // Case management relations
  caseInternalNotes       CaseInternalNote[]       @relation("CaseInternalNotes")
  createdIEPs             IEP[]                    @relation("CreatedIEPs")
  createdIEPTemplates     IEPTemplate[]            @relation("CreatedIEPTemplates")
  caseDocuments           CaseDocument[]           @relation("CaseDocuments")
  caseSharedWith          CaseShare[]              @relation("CaseSharedWith")
  caseSharedBy            CaseShare[]              @relation("CaseSharedBy")
  createdTreatmentPlans   TreatmentPlan[]          @relation("CreatedTreatmentPlans")
  caseAuditLogs           CaseAuditLog[]           @relation("CaseAuditLogs")
  caseConsents            CaseConsent[]            @relation("CaseConsents")
  caseSessions            CaseSession[]            @relation("CaseSessionTherapist")

  // Learning resources relations
  worksheets              Worksheet[]              @relation("UserWorksheets")
  sentWorksheetAssignments     WorksheetAssignment[] @relation("SentWorksheetAssignments")
  receivedWorksheetAssignments WorksheetAssignment[] @relation("ReceivedWorksheetAssignments")
  worksheetReviews        WorksheetReview[]         @relation("UserWorksheetReviews")
  worksheetFlags          WorksheetFlag[]           @relation("UserWorksheetFlags")
  resolvedWorksheetFlags  WorksheetFlag[]           @relation("ResolvedWorksheetFlags")

  // Verified contributor
  isVerifiedContributor   Boolean                   @default(false)
  verifiedContributorAt   DateTime?
  contributorBio          String?

  @@index([email])
  @@index([role])
  @@index([verificationStatus])
  @@index([state, city])
  @@index([preferredLanguage])
  @@index([resetPasswordToken])
  @@index([googleId])
}

model Community {
  id                      String            @id @default(cuid())
  slug                    String            @unique
  name                    String
  description             String?
  type                    String
  condition               String?
  ageRange                Int[]             @default([])
  location                String?
  parentId                String?
  creatorId               String
  isPrivate               Boolean           @default(false)
  requiresApproval        Boolean           @default(false)
  inviteOnly              Boolean           @default(false)
  rules                   String?
  welcomeMessage          String?
  bannerImage             String?
  icon                    String?
  tags                    String[]          @default([])
  whatsappEnabled         Boolean           @default(false)
  autoCreateWhatsAppGroup Boolean           @default(false)
  whatsappGroupLimit      Int               @default(256)
  primaryLanguage         String            @default("en")
  supportedLanguages      String[]          @default(["en", "hi"])
  memberCount             Int               @default(0)
  postCount               Int               @default(0)
  isActive                Boolean           @default(true)
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @updatedAt
  organizationId          String?
  creator                 User              @relation("CreatedCommunities", fields: [creatorId], references: [id])
  organization            Organization?     @relation(fields: [organizationId], references: [id])
  parent                  Community?        @relation("SubCommunities", fields: [parentId], references: [id], onDelete: Cascade)
  children                Community[]       @relation("SubCommunities")
  members                 CommunityMember[]
  events                  Event[]
  posts                   Post[]
  whatsappGroups          WhatsAppGroup[]

  @@index([type])
  @@index([condition])
  @@index([location])
  @@index([parentId])
  @@index([creatorId])
  @@index([isPrivate])
  @@index([slug])
}

model CommunityMember {
  id              String         @id @default(cuid())
  userId          String
  communityId     String
  role            CommunityRole  @default(MEMBER)
  permissions     Json?
  lastActive      DateTime?
  postCount       Int            @default(0)
  commentCount    Int            @default(0)
  reputation      Int            @default(0)
  whatsappNumber  String?
  whatsappGroupId String?
  whatsappSynced  Boolean        @default(false)
  status          MemberStatus   @default(ACTIVE)
  invitedBy       String?
  invitedAt       DateTime?
  approvedAt      DateTime?
  approvedBy      String?
  joinedAt        DateTime       @default(now())
  community       Community      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsappGroup   WhatsAppGroup? @relation(fields: [whatsappGroupId], references: [id])

  @@unique([userId, communityId])
  @@index([userId])
  @@index([communityId])
  @@index([whatsappGroupId])
  @@index([status])
  @@index([role])
}

model WhatsAppGroup {
  id                  String               @id @default(cuid())
  communityId         String
  name                String
  description         String?
  groupLink           String
  qrCodeUrl           String?
  memberLimit         Int                  @default(256)
  currentCount        Int                  @default(0)
  isFull              Boolean              @default(false)
  groupNumber         Int                  @default(1)
  isOverflow          Boolean              @default(false)
  language            String               @default("en")
  region              String?
  adminUserId         String?
  adminWhatsAppNumber String?
  isActive            Boolean              @default(true)
  lastSynced          DateTime?
  syncStatus          String?
  autoWelcomeMessage  Boolean              @default(true)
  allowMemberInvites  Boolean              @default(true)
  moderationEnabled   Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  members             CommunityMember[]
  admin               User?                @relation("WhatsAppGroupAdmin", fields: [adminUserId], references: [id])
  community           Community            @relation(fields: [communityId], references: [id], onDelete: Cascade)
  invitations         WhatsAppInvitation[]

  @@index([communityId])
  @@index([adminUserId])
  @@index([isFull])
  @@index([language])
  @@index([isActive])
}

model WhatsAppInvitation {
  id              String           @id @default(cuid())
  whatsappGroupId String
  userId          String
  status          InvitationStatus @default(PENDING)
  inviteCode      String           @unique
  expiresAt       DateTime?
  sentVia         String?
  sentAt          DateTime?
  joinedAt        DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  whatsappGroup   WhatsAppGroup    @relation(fields: [whatsappGroupId], references: [id], onDelete: Cascade)

  @@unique([whatsappGroupId, userId])
  @@index([inviteCode])
  @@index([status])
  @@index([userId])
}

model Event {
  id                      String          @id @default(cuid())
  communityId             String?
  createdBy               String
  title                   String
  description             String
  coverImage              String?
  eventType               EventCategory
  format                  EventFormat
  startDate               DateTime
  endDate                 DateTime?
  timezone                String          @default("Asia/Kolkata")
  venue                   String?
  address                 String?
  city                    String?
  state                   String?
  location                String?
  meetingLink             String?
  virtualLink             String?
  platform                String?
  ageGroup                String[]
  languages               String[]
  accessibilityFeatures   String[]
  specialInstructions     String?
  contactPhone            String?
  contactEmail            String?
  contactWhatsApp         String?
  externalLink            String?
  isPublic                Boolean         @default(true)
  shareToFeed             Boolean         @default(true)
  tags                    String[]
  interestedCount         Int             @default(0)
  viewCount               Int             @default(0)
  status                  EventStatus     @default(PUBLISHED)
  isCancelled             Boolean         @default(false)
  cancellationReason      String?
  isActive                Boolean         @default(true)
  whatsappReminderEnabled Boolean         @default(false)
  whatsappGroupId         String?
  maxAttendees            Int?
  attendeeCount           Int             @default(0)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  feedPostId              String?         @unique
  organizationId          String?
  community               Community?      @relation(fields: [communityId], references: [id], onDelete: Cascade)
  creator                 User            @relation("EventCreator", fields: [createdBy], references: [id])
  feedPost                Post?           @relation("EventPost", fields: [feedPostId], references: [id])
  organization            Organization?   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  interests               EventInterest[]

  @@index([communityId])
  @@index([organizationId])
  @@index([startDate])
  @@index([status])
  @@index([eventType])
  @@index([city, state])
  @@index([createdBy])
}

model EventInterest {
  id        String         @id @default(cuid())
  eventId   String
  userId    String
  status    InterestStatus @default(INTERESTED)
  createdAt DateTime       @default(now())
  event     Event          @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User           @relation(fields: [userId], references: [id])

  @@unique([eventId, userId])
  @@index([userId])
  @@index([status])
}

model Post {
  id                     String                 @id @default(cuid())
  title                  String
  content                String
  summary                String?
  type                   PostType
  category               String
  tags                   String[]
  authorId               String
  viewCount              Int                    @default(0)
  upvotes                Int                    @default(0)
  downvotes              Int                    @default(0)
  insights               String[]               @default([])
  needsReview            Boolean                @default(false)
  moderationNotes        String?
  metadata               Json?
  isPinned               Boolean                @default(false)
  isLocked               Boolean                @default(false)
  isPublished            Boolean                @default(true)
  moderationStatus       ModerationStatus       @default(PENDING)
  sentiment              Float?
  toxicity               Float?
  containsCrisisKeywords Boolean                @default(false)
  embedding              Float[]                @default([])
  communityId            String?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt
  bookmarks              Bookmark[]
  comments               Comment[]
  engagementEvents       EngagementEvent[]
  event                  Event?                 @relation("EventPost")
  feedInteractions       FeedInteraction[]
  author                 User                   @relation(fields: [authorId], references: [id], onDelete: Cascade)
  community              Community?             @relation(fields: [communityId], references: [id])
  engagementMetrics      PostEngagementMetrics?
  views                  PostView[]
  reports                Report[]
  resources              Resource[]
  similarPosts           SimilarPost[]          @relation("OriginalPost")
  relatedPosts           SimilarPost[]          @relation("RelatedPost")
  votes                  Vote[]

  @@index([authorId])
  @@index([category])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@index([moderationStatus])
  @@index([communityId])
  @@index([containsCrisisKeywords])
  @@index([needsReview])
}

model UserPreferences {
  id                    String      @id @default(cuid())
  userId                String      @unique
  defaultFeedView       FeedView    @default(FOR_YOU)
  feedDensity           FeedDensity @default(COMFORTABLE)
  showAnonymousPosts    Boolean     @default(true)
  autoplayVideos        Boolean     @default(false)
  preferredCategories   String[]
  mutedKeywords         String[]
  mutedAuthors          String[]
  preferredLanguages    String[]
  recencyWeight         Int         @default(30)
  relevanceWeight       Int         @default(40)
  engagementWeight      Int         @default(30)
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt
  allowDirectMessages   Boolean     @default(true)
  blockedCategories     String[]    @default([])
  blockedTags           String[]    @default([])
  contentTypes          String[]    @default([])
  crisisAutoDetection   Boolean     @default(false)
  crisisModuleEnabled   Boolean     @default(true)
  desktopNotifications  Boolean     @default(false)
  emailDigestFrequency  String      @default("daily")
  emailEnabled          Boolean     @default(true)
  emailNotifications    Boolean     @default(true)
  emergencyContacts     String[]    @default([])
  followedTags          String[]    @default([])
  inAppSoundEnabled     Boolean     @default(true)
  minEngagement         Int         @default(0)
  notificationFrequency String      @default("daily")
  notificationPrefs     Json?
  notificationTypes     Json        @default("{}")
  preferredHelplines    String[]    @default([])
  profilePublic         Boolean     @default(true)
  pushEnabled           Boolean     @default(false)
  pushNotifications     Boolean     @default(false)
  quietHoursEnabled     Boolean     @default(false)
  quietHoursEnd         String?
  quietHoursStart       String?
  savedCrisisResources  Json?
  showCrisisButton      Boolean     @default(true)
  showEmail             Boolean     @default(false)
  showSOSButton         Boolean     @default(true)
  verifiedAuthorsOnly   Boolean     @default(false)
  user                  User        @relation(fields: [userId], references: [id])

  @@index([userId])
}

model UserInterests {
  id           String   @id @default(cuid())
  userId       String
  category     String
  score        Float    @default(0)
  interactions Int      @default(0)
  lastEngaged  DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id])

  @@unique([userId, category])
  @@index([userId, score])
}

model FeedInteraction {
  id          String          @id @default(cuid())
  userId      String
  postId      String
  action      InteractionType
  duration    Int?
  scrollDepth Float?
  timestamp   DateTime        @default(now())
  post        Post            @relation(fields: [postId], references: [id])
  user        User            @relation(fields: [userId], references: [id])

  @@index([userId, timestamp])
  @@index([postId, action])
}

model PostView {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  viewedAt  DateTime @default(now())
  duration  Int?
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId, viewedAt])
  @@index([postId, createdAt])
  @@index([userId])
}

model EngagementEvent {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  eventType String
  value     Int?
  createdAt DateTime @default(now())
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([postId, eventType, createdAt])
  @@index([userId])
}

model PostEngagementMetrics {
  id                 String   @id @default(cuid())
  postId             String   @unique
  engagementLast1h   Int      @default(0)
  engagementLast24h  Int      @default(0)
  engagementLast7d   Int      @default(0)
  engagementLast30d  Int      @default(0)
  velocityScore      Float    @default(0)
  velocityTrend      String   @default("stable")
  collaborativeScore Float    @default(0)
  qualityScore       Float    @default(0)
  relevanceScore     Float    @default(0)
  lastCalculatedAt   DateTime @default(now())
  updatedAt          DateTime @updatedAt
  post               Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([velocityScore])
  @@index([lastCalculatedAt])
}

model UserSimilarity {
  id             String   @id @default(cuid())
  userId         String
  similarUserId  String
  similarity     Float
  lastCalculated DateTime @default(now())
  similarUser    User     @relation("UserSimilarityTo", fields: [similarUserId], references: [id], onDelete: Cascade)
  user           User     @relation("UserSimilarityFrom", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, similarUserId])
  @@index([userId, similarity])
}

model UserInteractionProfile {
  id                  String   @id @default(cuid())
  userId              String   @unique
  categoryPreferences Json     @default("[]")
  tagPreferences      Json     @default("[]")
  typePreferences     Json     @default("[]")
  avgEngagementTime   Int      @default(0)
  upvoteRatio         Float    @default(0.5)
  commentFrequency    Float    @default(0)
  activeHours         Json     @default("[]")
  activeDays          Json     @default("[]")
  lastUpdated         DateTime @default(now())
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Comment {
  id                     String    @id @default(cuid())
  content                String
  postId                 String
  authorId               String
  parentId               String?
  upvotes                Int       @default(0)
  downvotes              Int       @default(0)
  isEdited               Boolean   @default(false)
  editedAt               DateTime?
  isDeleted              Boolean   @default(false)
  deletedAt              DateTime?
  deletedBy              String?
  sentiment              Float?
  toxicity               Float?
  helpful                Boolean?
  containsCrisisKeywords Boolean   @default(false)
  flagged                Boolean   @default(false)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  author                 User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent                 Comment?  @relation("CommentToComment", fields: [parentId], references: [id])
  replies                Comment[] @relation("CommentToComment")
  post                   Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  reports                Report[]
  votes                  Vote[]

  @@index([authorId])
  @@index([parentId])
  @@index([postId])
}

model Vote {
  id         String   @id @default(cuid())
  value      Int
  userId     String
  targetId   String
  targetType String
  postId     String?
  commentId  String?
  createdAt  DateTime @default(now())
  comment    Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  post       Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@unique([userId, postId])
  @@unique([userId, targetId, targetType])
  @@index([commentId])
  @@index([postId])
  @@index([targetId, targetType])
  @@index([userId])
}

model Bookmark {
  id         String    @id @default(cuid())
  userId     String
  postId     String?
  createdAt  DateTime  @default(now())
  questionId String?
  post       Post?     @relation(fields: [postId], references: [id], onDelete: Cascade)
  question   Question? @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, questionId])
  @@index([postId])
  @@index([questionId])
  @@index([userId])
}

model Resource {
  id          String       @id @default(cuid())
  postId      String?
  title       String
  description String?
  source      String
  url         String?
  type        ResourceType
  relevance   Float?
  authors     String[]
  publishDate DateTime?
  doi         String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  post        Post?        @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId])
  @@index([type])
}

model SimilarPost {
  id             String   @id @default(cuid())
  originalPostId String
  relatedPostId  String
  similarity     Float
  reason         String?
  createdAt      DateTime @default(now())
  originalPost   Post     @relation("OriginalPost", fields: [originalPostId], references: [id], onDelete: Cascade)
  relatedPost    Post     @relation("RelatedPost", fields: [relatedPostId], references: [id], onDelete: Cascade)

  @@unique([originalPostId, relatedPostId])
  @@index([originalPostId])
  @@index([similarity])
}

model DirectMessage {
  id             String   @id @default(cuid())
  fromId         String
  toId           String
  content        String
  read           Boolean  @default(false)
  connectionType String?
  matchReason    String?
  createdAt      DateTime @default(now())

  @@index([fromId])
  @@index([toId])
  @@index([read])
}

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())
  follower    User     @relation("UserFollowers", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("UserFollowing", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Notification {
  id                String   @id @default(cuid())
  userId            String
  type              String
  title             String
  message           String
  read              Boolean  @default(false)
  relatedPostId     String?
  relatedUserId     String?
  senderId          String?
  createdAt         DateTime @default(now())
  actionUrl         String?
  metadata          Json?
  priority          String   @default("medium")
  relatedEntityId   String?
  relatedEntityType String?
  updatedAt         DateTime @updatedAt
  sender            User?    @relation("NotificationSender", fields: [senderId], references: [id])
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@index([createdAt])
}

model VerificationDoc {
  id           String             @id @default(cuid())
  userId       String
  type         String
  fileUrl      String
  status       VerificationStatus @default(PENDING)
  reviewedBy   String?
  reviewNotes  String?
  aiVerified   Boolean            @default(false)
  aiConfidence Float?
  aiNotes      Json?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  user         User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Report {
  id             String    @id @default(cuid())
  userId         String
  reporterId     String?
  targetId       String
  targetType     String?
  type           String
  reason         String
  description    String?
  details        String?
  status         String    @default("pending")
  aiSeverity     Float?
  aiCategory     String?
  resolvedBy     String?
  resolution     String?
  resolvedAt     DateTime?
  postId         String?
  commentId      String?
  createdAt      DateTime  @default(now())
  comment        Comment?  @relation(fields: [commentId], references: [id])
  post           Post?     @relation(fields: [postId], references: [id])
  reportedAnswer Answer    @relation("AnswerReports", fields: [targetId], references: [id])
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([targetId])
  @@index([status])
  @@index([targetType, targetId])
}

model ModerationLog {
  id          String   @id @default(cuid())
  moderatorId String
  userId      String
  action      String
  targetType  String
  targetId    String
  reason      String?
  details     String?
  metadata    Json?
  notes       String?
  aiSuggested Boolean  @default(false)
  aiReasoning String?
  createdAt   DateTime @default(now())
  moderator   User     @relation("ModeratorLogs", fields: [moderatorId], references: [id])
  user        User     @relation("UserActionLogs", fields: [userId], references: [id])

  @@index([moderatorId])
  @@index([userId])
  @@index([targetId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model AiSession {
  id         String   @id @default(cuid())
  userId     String
  messages   Json
  context    Json?
  tokensUsed Int      @default(0)
  model      String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model Analytics {
  id         String   @id @default(cuid())
  userId     String?
  postId     String?
  event      String
  metadata   Json?
  userIntent String?
  category   String?
  createdAt  DateTime @default(now())

  @@index([createdAt])
  @@index([event])
  @@index([postId])
  @@index([userId])
}

model AiSubscription {
  id                   String   @id @default(cuid())
  userId               String   @unique
  stripeSubscriptionId String   @unique
  status               String
  currentPeriodEnd     DateTime
  planId               String
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  user                 User     @relation(fields: [userId], references: [id])
}

model AiUsage {
  id            String   @id @default(cuid())
  userId        String   @unique
  count         Int      @default(0)
  limit         Int      @default(3)
  lastResetDate DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])
}

model CrisisIncident {
  id                String             @id @default(cuid())
  userId            String?
  type              CrisisType
  urgencyLevel      UrgencyLevel
  description       String?
  location          String?
  state             String?
  city              String?
  contactNumber     String?
  preferredLang     String             @default("en")
  status            CrisisStatus       @default(ACTIVE)
  resolvedAt        DateTime?
  resolvedBy        String?
  resolutionNotes   String?
  resourcesUsed     String[]
  volunteerId       String?
  followupScheduled DateTime?
  followupCompleted Boolean            @default(false)
  followupNotes     String?
  triggerKeywords   String[]
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  auditLogs         CrisisAuditLog[]
  connections       CrisisConnection[]
  user              User?              @relation(fields: [userId], references: [id])
  logs              CrisisLog[]

  @@index([userId])
  @@index([status])
  @@index([urgencyLevel])
  @@index([type])
  @@index([createdAt])
  @@index([state, city])
}

model CrisisResource {
  id             String       @id @default(cuid())
  name           String
  type           String
  category       CrisisType[]
  phoneNumber    String?
  whatsappNumber String?
  email          String?
  website        String?
  available24x7  Boolean      @default(false)
  operatingHours String?
  languages      String[]
  country        String       @default("IN")
  state          String?
  city           String?
  pincode        String?
  address        String?
  priority       Int          @default(100)
  isVerified     Boolean      @default(false)
  verifiedAt     DateTime?
  usageCount     Int          @default(0)
  avgRating      Float?
  description    String?
  specialization String[]
  ageGroups      String[]
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([state, city])
  @@index([type])
  @@index([priority])
  @@index([isActive])
}

model CrisisLog {
  id          String         @id @default(cuid())
  incidentId  String
  action      String
  details     Json?
  performedBy String?
  createdAt   DateTime       @default(now())
  incident    CrisisIncident @relation(fields: [incidentId], references: [id])

  @@index([incidentId])
  @@index([createdAt])
}

model CrisisVolunteer {
  id                String             @id @default(cuid())
  userId            String             @unique
  trainingCompleted Boolean            @default(false)
  certifications    String[]
  specializations   CrisisType[]
  languages         String[]
  isAvailable       Boolean            @default(false)
  availableFrom     DateTime?
  availableTill     DateTime?
  maxCasesPerDay    Int                @default(3)
  currentCases      Int                @default(0)
  state             String
  city              String
  timezone          String             @default("Asia/Kolkata")
  casesHandled      Int                @default(0)
  avgRating         Float?
  isActive          Boolean            @default(true)
  approvedAt        DateTime?
  approvedBy        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  connections       CrisisConnection[]
  user              User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isAvailable])
  @@index([state, city])
  @@index([isAvailable, state, city])
}

model CrisisConnection {
  id             String           @id @default(cuid())
  incidentId     String
  volunteerId    String?
  resourceId     String?
  connectionType String
  startedAt      DateTime         @default(now())
  endedAt        DateTime?
  duration       Int?
  outcome        String?
  notes          String?
  rating         Int?
  feedback       String?
  createdAt      DateTime         @default(now())
  incident       CrisisIncident   @relation(fields: [incidentId], references: [id])
  volunteer      CrisisVolunteer? @relation(fields: [volunteerId], references: [id])

  @@index([incidentId])
  @@index([volunteerId])
}

model CrisisAuditLog {
  id         String          @id @default(cuid())
  incidentId String?
  userId     String?
  action     String
  resourceId String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime        @default(now())
  incident   CrisisIncident? @relation(fields: [incidentId], references: [id])

  @@index([action])
  @@index([incidentId])
  @@index([timestamp])
  @@index([userId])
}

model Question {
  id                String             @id @default(cuid())
  title             String
  content           String
  slug              String             @unique
  authorId          String
  viewCount         Int                @default(0)
  answerCount       Int                @default(0)
  followerCount     Int                @default(0)
  hasAcceptedAnswer Boolean            @default(false)
  acceptedAnswerId  String?
  isAnonymous       Boolean            @default(false)
  anonymousName     String?
  status            QuestionStatus     @default(OPEN)
  closedReason      String?
  closedAt          DateTime?
  topics            String[]
  tags              String[]
  category          String
  moderationStatus  ModerationStatus   @default(APPROVED)
  needsReview       Boolean            @default(false)
  moderationNotes   String?
  embedding         Float[]            @default([])
  summary           String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  lastActivityAt    DateTime           @default(now())
  mergedIntoId      String?
  answers           Answer[]
  requests          AnswerRequest[]
  bookmarks         Bookmark[]
  author            User               @relation("QuestionAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  mergedInto        Question?          @relation("MergedQuestions", fields: [mergedIntoId], references: [id])
  mergedQuestions   Question[]         @relation("MergedQuestions")
  followers         QuestionFollower[]
  relatedQuestions  RelatedQuestion[]  @relation("OriginalQuestion")
  relatedFrom       RelatedQuestion[]  @relation("RelatedQuestion")

  @@index([authorId])
  @@index([status])
  @@index([category])
  @@index([lastActivityAt])
  @@index([answerCount])
  @@index([viewCount])
  @@index([slug])
}

model Answer {
  id               String           @id @default(cuid())
  questionId       String
  authorId         String
  content          String
  originalContent  String?
  isAccepted       Boolean          @default(false)
  acceptedAt       DateTime?
  isAnonymous      Boolean          @default(false)
  qualityScore     Float            @default(5.0)
  helpfulVotes     Int              @default(0)
  notHelpfulVotes  Int              @default(0)
  readTime         Int?
  hasMedia         Boolean          @default(false)
  wordCount        Int?
  moderationStatus ModerationStatus @default(APPROVED)
  moderationNotes  String?
  toxicity         Float?
  embedding        Float[]          @default([])
  summary          String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  lastEditedAt     DateTime?
  author           User             @relation("AnswerAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  question         Question         @relation(fields: [questionId], references: [id], onDelete: Cascade)
  comments         AnswerComment[]
  edits            AnswerEdit[]
  views            AnswerView[]
  votes            AnswerVote[]
  reports          Report[]         @relation("AnswerReports")

  @@index([questionId])
  @@index([authorId])
  @@index([isAccepted])
  @@index([qualityScore])
  @@index([createdAt])
}

model AnswerVote {
  id        String   @id @default(cuid())
  answerId  String
  userId    String
  value     Int
  createdAt DateTime @default(now())
  answer    Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user      User     @relation("AnswerVotes", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([answerId, userId])
  @@index([answerId])
  @@index([userId])
}

model AnswerComment {
  id        String   @id @default(cuid())
  answerId  String
  authorId  String
  content   String
  upvotes   Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  answer    Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  author    User     @relation("AnswerComments", fields: [authorId], references: [id], onDelete: Cascade)

  @@index([answerId])
  @@index([authorId])
}

model AnswerEdit {
  id         String   @id @default(cuid())
  answerId   String
  content    String
  editReason String?
  createdAt  DateTime @default(now())
  answer     Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)

  @@index([answerId])
  @@index([createdAt])
}

model QuestionFollower {
  id          String   @id @default(cuid())
  questionId  String
  userId      String
  notifyEmail Boolean  @default(true)
  notifyPush  Boolean  @default(true)
  createdAt   DateTime @default(now())
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  user        User     @relation("QuestionFollowers", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([questionId, userId])
  @@index([userId])
  @@index([questionId])
}

model AnswerRequest {
  id              String        @id @default(cuid())
  questionId      String
  requesterId     String
  requestedUserId String
  message         String?
  status          RequestStatus @default(PENDING)
  createdAt       DateTime      @default(now())
  respondedAt     DateTime?
  question        Question      @relation(fields: [questionId], references: [id], onDelete: Cascade)
  requestedUser   User          @relation("ReceivedRequests", fields: [requestedUserId], references: [id], onDelete: Cascade)
  requester       User          @relation("SentRequests", fields: [requesterId], references: [id], onDelete: Cascade)

  @@unique([questionId, requesterId, requestedUserId])
  @@index([questionId])
  @@index([requestedUserId])
  @@index([status])
}

model RelatedQuestion {
  id                String   @id @default(cuid())
  questionId        String
  relatedQuestionId String
  similarity        Float
  reason            String?
  createdAt         DateTime @default(now())
  question          Question @relation("OriginalQuestion", fields: [questionId], references: [id], onDelete: Cascade)
  relatedQuestion   Question @relation("RelatedQuestion", fields: [relatedQuestionId], references: [id], onDelete: Cascade)

  @@unique([questionId, relatedQuestionId])
  @@index([questionId])
  @@index([similarity])
}

model AnswerView {
  id        String   @id @default(cuid())
  answerId  String
  userId    String?
  ipAddress String?
  viewedAt  DateTime @default(now())
  answer    Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  user      User?    @relation("AnswerViews", fields: [userId], references: [id], onDelete: Cascade)

  @@index([answerId])
  @@index([viewedAt])
  @@index([userId])
}

model Provider {
  id                String         @id @default(cuid())
  serialNumber      Int            @unique
  state             String
  city              String
  organizationName  String
  organizationType  String
  contactPersonName String?
  contactNumber     String?
  email             String?
  address           String?
  websiteLinkedin   String?
  normalizedState   String
  normalizedOrgType String
  searchVector      String?
  latitude          Float?
  longitude         Float?
  isVerified        Boolean        @default(false)
  verifiedAt        DateTime?
  verifiedBy        String?
  viewCount         Int            @default(0)
  contactClickCount Int            @default(0)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  addedById         String?
  views             ProviderView[]
  addedBy           User?          @relation("ProviderCreator", fields: [addedById], references: [id])

  @@index([state, city])
  @@index([normalizedState])
  @@index([normalizedOrgType])
  @@index([organizationName])
  @@index([isVerified])
  @@map("providers")
}

model ProviderView {
  id         String   @id @default(cuid())
  providerId String
  userId     String?
  ipAddress  String?
  userAgent  String?
  viewedAt   DateTime @default(now())
  provider   Provider @relation(fields: [providerId], references: [id], onDelete: Cascade)
  user       User?    @relation("UserProviderViews", fields: [userId], references: [id])

  @@index([providerId])
  @@index([userId])
  @@index([viewedAt])
  @@map("provider_views")
}

model UserProfile {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  fullName                String?
  relationshipToChild     String?
  phoneNumber             String?
  alternatePhone          String?
  email                   String?
  city                    String?
  state                   String?
  pincode                 String?
  occupation              String?
  educationLevel          String?
  preferredLanguage       String    @default("en")
  communicationPreference String?
  onboardingCompleted     Boolean   @default(false)
  onboardingStep          Int       @default(0)
  completenessScore       Int       @default(0)
  lastCompletedAt         DateTime?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  country                 String?
  children                Child[]
  user                    User      @relation("UserProfile", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([completenessScore])
  @@map("user_profiles")
}

model Child {
  id                                    String           @id @default(cuid())
  profileId                             String
  firstName                             String
  nickname                              String?
  dateOfBirth                           DateTime
  gender                                String
  schoolType                            String?
  grade                                 String?
  hasCondition                          Boolean          @default(false)
  diagnosisStatus                       String?
  createdAt                             DateTime         @default(now())
  updatedAt                             DateTime         @updatedAt
  address                               String?
  attendancePattern                     String?
  birthComplications                    String?
  birthOrder                            String?
  birthWeight                           String?
  caregiverRelationship                 String?
  city                                  String?
  currentMedicalConditions              String?
  currentSchool                         String?
  delayedMilestones                     Boolean?
  delayedMilestonesDetails              String?
  deliveryType                          String?
  developmentalConcerns                 String?
  eatingDetails                         String?
  eatingIssues                          Boolean?
  familyHistoryOfDevelopmentalDisorders String?
  gestationalAge                        String?
  learningDifficulties                  String?
  medicationDetails                     String?
  mediumOfInstruction                   String?
  mothersHealthDuringPregnancy          String?
  nationality                           String?
  placeOfBirth                          String?
  postalCode                            String?
  prematureBirth                        Boolean?
  previousAssessments                   Boolean?
  primaryLanguage                       String?
  referralSource                        String?
  sleepDetails                          String?
  sleepIssues                           Boolean?
  state                                 String?
  takingMedications                     Boolean?
  teacherConcerns                       String?
  visionHearingIssues                   String?
  assessments                           Assessment[]
  conditions                            ChildCondition[]
  cases                                 Case[]
  worksheets                            Worksheet[]      @relation("ChildWorksheets")
  worksheetAssignments                  WorksheetAssignment[] @relation("ChildWorksheetAssignments")
  worksheetCompletions                  WorksheetCompletion[]
  worksheetEffectiveness                WorksheetEffectiveness[]
  profile                               UserProfile      @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([dateOfBirth])
  @@map("children")
}

model ChildCondition {
  id                String    @id @default(cuid())
  childId           String
  conditionType     String
  diagnosedAt       DateTime?
  diagnosedBy       String?
  severity          String?
  specificDiagnosis String?
  currentTherapies  String[]  @default([])
  medications       String[]  @default([])
  primaryChallenges String?
  strengths         String?
  notes             String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  child             Child     @relation(fields: [childId], references: [id], onDelete: Cascade)

  @@index([childId])
  @@index([conditionType])
  @@map("child_conditions")
}

model ProfileCompletenessLog {
  id                String   @id @default(cuid())
  userId            String
  basicInfoComplete Boolean  @default(false)
  contactComplete   Boolean  @default(false)
  childrenAdded     Boolean  @default(false)
  conditionsAdded   Boolean  @default(false)
  totalScore        Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId])
  @@map("profile_completeness_logs")
}

model Organization {
  id                   String                      @id @default(cuid())
  name                 String
  slug                 String                      @unique
  description          String?
  logo                 String?
  banner               String?
  website              String?
  createdAt            DateTime                    @default(now())
  updatedAt            DateTime                    @updatedAt
  commissionPercentage Float?
  communities          Community[]
  events               Event[]
  invitations          OrganizationInvitation[]
  members              OrganizationMember[]
  bookingPackages      BookingPackage[]
  bookings             Booking[]
  marketplaceSettings  MarketplaceSettings?
  sessionTypes         SessionType[]
  therapistLinks       TherapistOrganizationLink[]

  // Case management relations
  cases                Case[]
  iepTemplates         IEPTemplate[]

  @@index([slug])
}

model OrganizationMember {
  id             String             @id @default(cuid())
  userId         String
  organizationId String
  role           OrganizationRole   @default(MEMBER)
  status         OrganizationStatus @default(ACTIVE)
  joinedAt       DateTime?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User               @relation("UserOrganizationMemberships", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model OrganizationInvitation {
  id             String                   @id @default(cuid())
  email          String
  organizationId String
  role           OrganizationRole         @default(MEMBER)
  token          String                   @unique
  status         OrganizationInviteStatus @default(PENDING)
  invitedById    String
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
  invitedBy      User                     @relation("SentOrganizationInvites", fields: [invitedById], references: [id], onDelete: Cascade)
  organization   Organization             @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([email, organizationId])
  @@index([email])
  @@index([token])
  @@index([organizationId])
  @@index([status])
}

model FcmToken {
  id        String     @id @default(cuid())
  userId    String
  email     String
  fcmToken  String     @unique
  device    DeviceType
  isActive  Boolean    @default(true)
  lastUsed  DateTime?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([email])
  @@index([device])
  @@index([isActive])
  @@index([fcmToken])
}

model ClinicalConversation {
  id        String            @id @default(cuid())
  userId    String
  title     String
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ClinicalMessage[]
  feedbacks ClinicalFeedback[]

  @@index([userId])
  @@index([updatedAt])
}

model ClinicalMessage {
  id             String               @id @default(cuid())
  conversationId String
  role           String               @default("user")
  content        String
  metadata       Json?
  createdAt      DateTime             @default(now())
  conversation   ClinicalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model ClinicalPlan {
  id        String   @id @default(cuid())
  userId    String
  title     String
  content   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ClinicalFeedback {
  id             String               @id @default(cuid())
  userId         String
  conversationId String
  value          Int                  // 1 (helpful) or -1 (not helpful)
  comment        String?
  createdAt      DateTime             @default(now())
  user           User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversation   ClinicalConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@unique([userId, conversationId])
  @@index([conversationId])
}

model Assessment {
  id                String               @id @default(cuid())
  childId           String
  ageGroup          String
  status            AssessmentStatus     @default(IN_PROGRESS)
  tier1Completed    Boolean              @default(false)
  tier2Completed    Boolean              @default(false)
  tier1CompletedAt  DateTime?
  tier2CompletedAt  DateTime?
  completedAt       DateTime?
  expiresAt         DateTime?
  overallScore      Float?
  domainScores      Json?
  flaggedDomains    String[]             @default([])
  reportGenerated   Boolean              @default(false)
  reportGeneratedAt DateTime?
  v2ReportGenerated Boolean              @default(false)
  v2ReportGeneratedAt DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  reports           AssessmentReport[]
  responses         AssessmentResponse[]
  shares            AssessmentShare[]
  child             Child                @relation(fields: [childId], references: [id], onDelete: Cascade)
  worksheets        Worksheet[]          @relation("WorksheetScreening")

  @@index([childId])
  @@index([status])
  @@index([createdAt])
  @@map("assessments")
}

model AssessmentResponse {
  id           String     @id @default(cuid())
  assessmentId String
  tier         Int
  domain       String
  questionId   String
  answer       AnswerType
  score        Float
  answeredAt   DateTime   @default(now())
  assessment   Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@unique([assessmentId, questionId])
  @@index([assessmentId])
  @@index([domain])
  @@map("assessment_responses")
}

model AssessmentReport {
  id               String     @id @default(cuid())
  assessmentId     String
  reportType       ReportType
  pdfUrl           String?
  v2Content        Json?
  generatedAt      DateTime   @default(now())
  downloadCount    Int        @default(0)
  lastDownloadedAt DateTime?
  assessment       Assessment @relation(fields: [assessmentId], references: [id], onDelete: Cascade)

  @@index([assessmentId])
  @@map("assessment_reports")
}

model AssessmentShare {
  id           String      @id @default(cuid())
  assessmentId String
  sharedBy     String
  sharedWith   String
  shareLink    String?     @unique
  accessLevel  AccessLevel @default(VIEW)
  annotations  Json?
  sharedAt     DateTime    @default(now())
  viewedAt     DateTime?
  lastViewedAt DateTime?
  isActive     Boolean     @default(true)
  assessment   Assessment  @relation(fields: [assessmentId], references: [id], onDelete: Cascade)
  parent       User        @relation("SharedAssessments", fields: [sharedBy], references: [id])
  therapist    User        @relation("ReceivedAssessments", fields: [sharedWith], references: [id])

  @@unique([assessmentId, sharedWith])
  @@index([sharedBy])
  @@index([sharedWith])
  @@index([shareLink])
  @@map("assessment_shares")
}

model TherapistProfile {
  id                       String                      @id @default(cuid())
  userId                   String                      @unique
  bio                      String?
  credentials              String[]                    @default([])
  specializations          String[]                    @default([])
  yearsExperience          Int?
  title                    String?
  profileImage             String?
  languages                String[]                    @default([])
  defaultTimezone          String                      @default("Asia/Kolkata")
  overallRating            Float                       @default(0)
  totalSessions            Int                         @default(0)
  totalRatings             Int                         @default(0)
  stripeAccountId          String?                     @unique
  stripeOnboardingComplete Boolean                     @default(false)
  isActive                 Boolean                     @default(true)
  acceptingBookings        Boolean                     @default(true)
  commissionPercentage     Float?
  createdAt                DateTime                    @default(now())
  updatedAt                DateTime                    @updatedAt
  availabilityExceptions   AvailabilityException[]
  packages                 BookingPackage[]
  bookings                 Booking[]
  questionnaires           PreSessionQuestionnaire[]
  sessionPricing           SessionPricing[]
  ratings                  SessionRating[]
  sessionTypes             SessionType[]
  availability             TherapistAvailability[]
  organizationLinks        TherapistOrganizationLink[]
  user                     User                        @relation("TherapistProfile", fields: [userId], references: [id], onDelete: Cascade)

  // Case management relations
  primaryCases             Case[]                      @relation("PrimaryTherapistCases")
  caseAssignments          CaseTherapist[]             @relation("CaseTherapistAssignments")

  @@index([userId])
  @@index([isActive])
  @@index([acceptingBookings])
  @@index([overallRating])
  @@map("therapist_profiles")
}

model TherapistOrganizationLink {
  id                     String                  @id @default(cuid())
  therapistId            String
  organizationId         String
  status                 TherapistApprovalStatus @default(PENDING)
  canWorkMultiple        Boolean                 @default(false)
  organizationPercentage Float                   @default(40)
  therapistPercentage    Float                   @default(60)
  pricingControl         PricingControl          @default(ORGANIZATION)
  approvedAt             DateTime?
  approvedBy             String?
  rejectedAt             DateTime?
  rejectionReason        String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  organization           Organization            @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  therapist              TherapistProfile        @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@unique([therapistId, organizationId])
  @@index([therapistId])
  @@index([organizationId])
  @@index([status])
  @@map("therapist_organization_links")
}

model SessionType {
  id             String            @id @default(cuid())
  name           String
  description    String?
  duration       Int
  defaultPrice   Float
  currency       String            @default("USD")
  organizationId String?
  therapistId    String?
  isActive       Boolean           @default(true)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  packages       BookingPackage[]
  bookings       Booking[]
  sessionPricing SessionPricing[]
  organization   Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  therapist      TherapistProfile? @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([therapistId])
  @@index([isActive])
  @@map("session_types")
}

model SessionPricing {
  id            String           @id @default(cuid())
  therapistId   String
  sessionTypeId String
  price         Float
  currency      String           @default("USD")
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  sessionType   SessionType      @relation(fields: [sessionTypeId], references: [id], onDelete: Cascade)
  therapist     TherapistProfile @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@unique([therapistId, sessionTypeId])
  @@index([therapistId])
  @@index([sessionTypeId])
  @@map("session_pricing")
}

model TherapistAvailability {
  id          String           @id @default(cuid())
  therapistId String
  dayOfWeek   Int
  startTime   String
  endTime     String
  timezone    String           @default("Asia/Kolkata")
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  therapist   TherapistProfile @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([therapistId])
  @@index([dayOfWeek])
  @@index([isActive])
  @@map("therapist_availability")
}

model AvailabilityException {
  id          String                    @id @default(cuid())
  therapistId String
  date        DateTime
  startTime   String?
  endTime     String?
  type        AvailabilityExceptionType
  reason      String?
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  therapist   TherapistProfile          @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([therapistId])
  @@index([date])
  @@index([type])
  @@map("availability_exceptions")
}

model Booking {
  id                           String                         @id @default(cuid())
  patientId                    String
  therapistId                  String
  sessionTypeId                String
  organizationId               String?
  startDateTime                DateTime
  endDateTime                  DateTime
  timezone                     String
  duration                     Int
  status                       BookingStatus                  @default(PENDING_PAYMENT)
  subtotal                     Float
  platformFee                  Float
  platformFeePercentage        Float                          @default(15)
  therapistAmount              Float
  organizationAmount           Float                          @default(0)
  currency                     String                         @default("USD")
  stripePaymentIntentId        String?                        @unique
  paymentStatus                PaymentStatus                  @default(PENDING)
  paidAt                       DateTime?
  escrowReleasedAt             DateTime?
  googleMeetLink               String?
  calendarEventId              String?
  meetingStartedAt             DateTime?
  patientJoinedAt              DateTime?
  therapistJoinedAt            DateTime?
  sessionCompletedAt           DateTime?
  patientConfirmedCompletion   Boolean                        @default(false)
  therapistConfirmedCompletion Boolean                        @default(false)
  cancelledBy                  String?
  cancelledAt                  DateTime?
  cancellationReason           String?
  refundAmount                 Float?
  refundedAt                   DateTime?
  patientNotes                 String?
  patientFiles                 String[]                       @default([])
  therapistAcceptedAt          DateTime?
  therapistRejectedAt          DateTime?
  rejectionReason              String?
  acceptanceDeadline           DateTime?
  createdAt                    DateTime                       @default(now())
  updatedAt                    DateTime                       @updatedAt
  questionnaireResponses       BookingQuestionnaireResponse[]
  organization                 Organization?                  @relation(fields: [organizationId], references: [id])
  patient                      User                           @relation("PatientBookings", fields: [patientId], references: [id])
  sessionType                  SessionType                    @relation(fields: [sessionTypeId], references: [id])
  therapist                    TherapistProfile               @relation(fields: [therapistId], references: [id])
  disputes                     SessionDispute[]
  ratings                      SessionRating[]
  caseSession                  CaseSession?

  @@index([patientId])
  @@index([therapistId])
  @@index([sessionTypeId])
  @@index([organizationId])
  @@index([status])
  @@index([startDateTime])
  @@index([paymentStatus])
  @@map("bookings")
}

model PreSessionQuestionnaire {
  id          String                         @id @default(cuid())
  therapistId String
  title       String
  description String?
  questions   Json
  isEnabled   Boolean                        @default(true)
  createdAt   DateTime                       @default(now())
  updatedAt   DateTime                       @updatedAt
  responses   BookingQuestionnaireResponse[]
  therapist   TherapistProfile               @relation(fields: [therapistId], references: [id], onDelete: Cascade)

  @@index([therapistId])
  @@index([isEnabled])
  @@map("pre_session_questionnaires")
}

model BookingQuestionnaireResponse {
  id              String                  @id @default(cuid())
  bookingId       String
  questionnaireId String
  responses       Json
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  booking         Booking                 @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  questionnaire   PreSessionQuestionnaire @relation(fields: [questionnaireId], references: [id])

  @@unique([bookingId, questionnaireId])
  @@index([bookingId])
  @@index([questionnaireId])
  @@map("booking_questionnaire_responses")
}

model SessionRating {
  id                    String           @id @default(cuid())
  bookingId             String
  ratedBy               String
  raterType             RaterType
  rating                Int
  review                String?
  professionalismRating Int?
  communicationRating   Int?
  helpfulnessRating     Int?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  therapistId           String
  booking               Booking          @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  rater                 User             @relation("SessionRatings", fields: [ratedBy], references: [id])
  therapist             TherapistProfile @relation(fields: [therapistId], references: [id])

  @@unique([bookingId, ratedBy])
  @@index([bookingId])
  @@index([ratedBy])
  @@index([therapistId])
  @@index([rating])
  @@map("session_ratings")
}

model BookingPackage {
  id               String            @id @default(cuid())
  name             String
  description      String?
  organizationId   String?
  therapistId      String?
  sessionTypeId    String
  numberOfSessions Int
  sessionsCount    Int
  totalPrice       Float
  packagePrice     Float
  regularPrice     Float
  pricePerSession  Float
  savings          Float
  validityDays     Int
  currency         String            @default("USD")
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  organization     Organization?     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  sessionType      SessionType       @relation(fields: [sessionTypeId], references: [id])
  therapist        TherapistProfile? @relation(fields: [therapistId], references: [id], onDelete: Cascade)
  purchases        PackagePurchase[]

  @@index([organizationId])
  @@index([therapistId])
  @@index([sessionTypeId])
  @@index([isActive])
  @@map("booking_packages")
}

model PackagePurchase {
  id                    String         @id @default(cuid())
  patientId             String
  packageId             String
  sessionsTotal         Int
  sessionsUsed          Int            @default(0)
  sessionsRemaining     Int
  totalPaid             Float
  currency              String         @default("USD")
  stripePaymentIntentId String?        @unique
  paymentStatus         PaymentStatus  @default(PENDING)
  paidAt                DateTime?
  purchasedAt           DateTime       @default(now())
  expiresAt             DateTime
  isActive              Boolean        @default(true)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  package               BookingPackage @relation(fields: [packageId], references: [id])
  patient               User           @relation("PackagePurchases", fields: [patientId], references: [id])

  @@index([patientId])
  @@index([packageId])
  @@index([expiresAt])
  @@index([isActive])
  @@map("package_purchases")
}

model SessionDispute {
  id              String        @id @default(cuid())
  bookingId       String
  raisedBy        String
  reason          String
  description     String
  evidence        Json?
  status          DisputeStatus @default(OPEN)
  resolvedBy      String?
  resolvedAt      DateTime?
  resolution      String?
  resolutionNotes String?
  refundAmount    Float?
  refundIssued    Boolean       @default(false)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  booking         Booking       @relation(fields: [bookingId], references: [id])
  raiser          User          @relation("RaisedDisputes", fields: [raisedBy], references: [id])
  resolver        User?         @relation("ResolvedDisputes", fields: [resolvedBy], references: [id])

  @@index([bookingId])
  @@index([raisedBy])
  @@index([status])
  @@map("session_disputes")
}

model MarketplaceSettings {
  id                         String       @id @default(cuid())
  organizationId             String       @unique
  allowMultiOrgTherapists    Boolean      @default(false)
  autoAcceptBookings         Boolean      @default(false)
  bufferMinutes              Int          @default(15)
  advanceBookingDays         Int          @default(90)
  minimumNoticeHours         Int          @default(12)
  defaultOrgPercentage       Float        @default(40)
  defaultTherapistPercentage Float        @default(60)
  enablePackages             Boolean      @default(true)
  enableQuestionnaires       Boolean      @default(true)
  createdAt                  DateTime     @default(now())
  updatedAt                  DateTime     @updatedAt
  organization               Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("marketplace_settings")
}

model PlatformSettings {
  id                           String   @id @default(cuid())
  platformCommissionPercentage Float    @default(15)
  escrowHoldHours              Int      @default(2)
  stripePlatformAccountId      String?
  enableMarketplace            Boolean  @default(true)
  parentOnboardingEnabled      Boolean  @default(true)
  therapistOnboardingEnabled   Boolean  @default(true)
  createdAt                    DateTime @default(now())
  updatedAt                    DateTime @updatedAt

  @@map("platform_settings")
}

//  Learning Resources 

model Worksheet {
  id            String              @id @default(cuid())
  title         String
  type          WorksheetType
  subType       String
  content       Json
  metadata      Json
  pdfUrl        String?
  previewUrl    String?
  status        WorksheetStatus     @default(DRAFT)
  colorMode     WorksheetColorMode  @default(FULL_COLOR)
  difficulty    WorksheetDifficulty @default(DEVELOPING)
  targetDomains String[]
  ageRangeMin   Int?
  ageRangeMax   Int?
  conditionTags String[]

  // Data source tracking
  dataSource        WorksheetDataSource @default(MANUAL)
  screeningId       String?
  screening         Assessment?         @relation("WorksheetScreening", fields: [screeningId], references: [id])
  caseId            String?
  case              Case?               @relation("CaseWorksheets", fields: [caseId], references: [id])
  iepGoalIds        String[]
  uploadedReportUrl String?
  parsedReportData  Json?

  // Session notes data source
  sessionNoteIds    String[]

  // Version tracking
  version           Int                 @default(1)
  parentVersionId   String?
  parentVersion     Worksheet?          @relation("WorksheetVersions", fields: [parentVersionId], references: [id])
  childVersions     Worksheet[]         @relation("WorksheetVersions")

  // Community library fields
  isPublic          Boolean             @default(false)
  publishedAt       DateTime?
  contributorNotes  String?
  clonedFromId      String?
  clonedFrom        Worksheet?          @relation("WorksheetClones", fields: [clonedFromId], references: [id])
  clones            Worksheet[]         @relation("WorksheetClones")
  cloneCount        Int                 @default(0)
  averageRating     Float?
  reviewCount       Int                 @default(0)

  createdById   String
  createdBy     User                @relation("UserWorksheets", fields: [createdById], references: [id])
  childId       String?
  child         Child?              @relation("ChildWorksheets", fields: [childId], references: [id])
  images        WorksheetImage[]
  assignments   WorksheetAssignment[]
  reviews       WorksheetReview[]
  flags         WorksheetFlag[]
  completions   WorksheetCompletion[]
  effectiveness WorksheetEffectiveness[]

  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@index([createdById])
  @@index([childId])
  @@index([type, status])
  @@index([createdAt])
  @@index([screeningId])
  @@index([caseId])
  @@index([isPublic, status])
  @@index([averageRating])
  @@index([clonedFromId])
  @@index([parentVersionId])
  @@map("worksheets")
}

model WorksheetImage {
  id            String               @id @default(cuid())
  worksheetId   String
  worksheet     Worksheet            @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  imageUrl      String
  prompt        String
  altText       String
  position      Int
  status        WorksheetImageStatus @default(PENDING)

  createdAt     DateTime             @default(now())

  @@index([worksheetId])
  @@map("worksheet_images")
}

model WorksheetAssignment {
  id            String                    @id @default(cuid())
  worksheetId   String
  worksheet     Worksheet                 @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  assignedById  String
  assignedBy    User                      @relation("SentWorksheetAssignments", fields: [assignedById], references: [id])
  assignedToId  String
  assignedTo    User                      @relation("ReceivedWorksheetAssignments", fields: [assignedToId], references: [id])
  childId       String
  child         Child                     @relation("ChildWorksheetAssignments", fields: [childId], references: [id])
  caseId        String?
  case          Case?                     @relation("CaseWorksheetAssignments", fields: [caseId], references: [id])
  status        WorksheetAssignmentStatus @default(ASSIGNED)
  dueDate       DateTime?
  notes         String?
  parentNotes   String?
  completedAt   DateTime?
  viewedAt      DateTime?
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt

  completions   WorksheetCompletion[]

  @@unique([worksheetId, assignedToId, childId])
  @@index([assignedById])
  @@index([assignedToId])
  @@index([childId])
  @@index([caseId])
  @@index([status])
  @@map("worksheet_assignments")
}

model WorksheetReview {
  id            String    @id @default(cuid())
  worksheetId   String
  worksheet     Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  userId        String
  user          User      @relation("UserWorksheetReviews", fields: [userId], references: [id])
  rating        Int
  reviewText    String?
  helpfulCount  Int       @default(0)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([worksheetId, userId])
  @@index([worksheetId])
  @@index([userId])
  @@index([rating])
  @@map("worksheet_reviews")
}

model WorksheetFlag {
  id            String              @id @default(cuid())
  worksheetId   String
  worksheet     Worksheet           @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  flaggedById   String
  flaggedBy     User                @relation("UserWorksheetFlags", fields: [flaggedById], references: [id])
  reason        WorksheetFlagReason
  details       String?
  status        WorksheetFlagStatus @default(PENDING)
  resolvedById  String?
  resolvedBy    User?               @relation("ResolvedWorksheetFlags", fields: [resolvedById], references: [id])
  resolvedAt    DateTime?
  resolution    String?

  createdAt     DateTime            @default(now())

  @@index([worksheetId])
  @@index([flaggedById])
  @@index([status])
  @@map("worksheet_flags")
}

model WorksheetCompletion {
  id                String               @id @default(cuid())
  worksheetId       String
  worksheet         Worksheet            @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  childId           String
  child             Child                @relation(fields: [childId], references: [id])
  assignmentId      String?
  assignment        WorksheetAssignment? @relation(fields: [assignmentId], references: [id])
  startedAt         DateTime             @default(now())
  completedAt       DateTime?
  timeSpentMinutes  Int?
  difficultyRating  Int?
  engagementRating  Int?
  helpLevel         String?
  parentNotes       String?
  completionQuality String?

  @@index([worksheetId])
  @@index([childId])
  @@index([assignmentId])
  @@index([completedAt])
  @@map("worksheet_completions")
}

model WorksheetEffectiveness {
  id              String    @id @default(cuid())
  worksheetId     String
  worksheet       Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  childId         String
  child           Child     @relation(fields: [childId], references: [id])
  domain          String
  preScore        Float?
  postScore       Float?
  progressDelta   Float?
  goalId          String?
  goalProgress    Float?
  measuredAt      DateTime  @default(now())

  @@index([worksheetId])
  @@index([childId])
  @@index([domain])
  @@map("worksheet_effectiveness")
}

enum WorksheetFlagReason {
  INAPPROPRIATE
  INACCURATE
  HARMFUL
  SPAM
  OTHER
}

enum WorksheetFlagStatus {
  PENDING
  REVIEWED
  DISMISSED
  ACTIONED
}

enum QuestionStatus {
  OPEN
  CLOSED
  MERGED
  DUPLICATE
}

enum RequestStatus {
  PENDING
  ACCEPTED
  DECLINED
  ANSWERED
}

enum Role {
  USER
  THERAPIST
  EDUCATOR
  ORGANIZATION
  ADMIN
  MODERATOR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum PostType {
  QUESTION
  DISCUSSION
  CASE_STUDY
  RESOURCE
  ANNOUNCEMENT
  STORY
}

enum ModerationStatus {
  PENDING
  APPROVED
  FLAGGED
  REJECTED
}

enum ResourceType {
  RESEARCH_PAPER
  GUIDELINE
  TOOL
  VIDEO
  COURSE
  ARTICLE
  PDF
  LINK
}

enum CostType {
  FREE
  PAID
  VARIES
}

enum CrisisStatus {
  ACTIVE
  IN_PROGRESS
  RESOLVED
  FOLLOWUP_PENDING
}

enum CrisisType {
  SUICIDE_RISK
  SELF_HARM
  MELTDOWN
  PANIC_ATTACK
  MEDICAL_EMERGENCY
  FAMILY_CONFLICT
  BURNOUT
  SUICIDE_PREVENTION
  MENTAL_HEALTH
  AUTISM_SUPPORT
  ADHD_SUPPORT
  CHILD_CRISIS
  WOMEN_CRISIS
  POISON_CONTROL
  LGBTQ_SUPPORT
  PARENT_SUPPORT
  GENERAL_COUNSELING
}

enum OrgType {
  NATIONAL_HELPLINE
  NGO
  HOSPITAL
  EMERGENCY_SERVICE
  SUPPORT_GROUP
}

enum UrgencyLevel {
  IMMEDIATE
  HIGH
  MODERATE
  LOW
}

enum CommunityRole {
  MEMBER
  MODERATOR
  ADMIN
  OWNER
}

enum MemberStatus {
  PENDING
  ACTIVE
  SUSPENDED
  BANNED
  LEFT
}

enum InvitationStatus {
  PENDING
  SENT
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum EventType {
  VIRTUAL
  IN_PERSON
  HYBRID
}

enum FeedView {
  FOR_YOU
  FOLLOWING
  COMMUNITIES
  BOOKMARKS
  TRENDING
  RECENT
}

enum FeedDensity {
  COMPACT
  COMFORTABLE
  SPACIOUS
}

enum InteractionType {
  VIEW
  CLICK
  VOTE
  COMMENT
  BOOKMARK
  SHARE
  HIDE
  REPORT
}

enum EventCategory {
  THERAPY_SESSION
  ASSESSMENT
  CONSULTATION
  WORKSHOP
  WEBINAR
  TRAINING
  PARENT_EDUCATION
  SUPPORT_GROUP
  PEER_MEETUP
  PLAYDATE
  SOCIAL_SKILLS
  AWARENESS_CAMPAIGN
  FUNDRAISER
  COMMUNITY_OUTREACH
  SENSORY_PLAY
  ART_THERAPY
  MUSIC_THERAPY
  SPORTS_ACTIVITY
  OTHER
}

enum EventFormat {
  VIRTUAL
  IN_PERSON
  HYBRID
}

enum EventStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum InterestStatus {
  INTERESTED
  GOING
}

enum OrganizationRole {
  ADMIN
  MEMBER
}

enum OrganizationStatus {
  PENDING
  ACTIVE
  REJECTED
  SUSPENDED
  DEACTIVATED
}

enum OrganizationInviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum DeviceType {
  WEB
  IOS
  ANDROID
  BROWSER
}

enum AssessmentStatus {
  IN_PROGRESS
  TIER1_COMPLETE
  TIER2_REQUIRED
  COMPLETED
  EXPIRED
}

enum AnswerType {
  YES
  SOMETIMES
  NOT_SURE
  NO
}

enum ReportType {
  SUMMARY
  DETAILED
  ENHANCED
}

enum AccessLevel {
  VIEW
  ANNOTATE
}

enum BookingStatus {
  PENDING_PAYMENT
  PAYMENT_FAILED
  PENDING_ACCEPTANCE
  ACCEPTED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_PATIENT
  CANCELLED_BY_THERAPIST
  NO_SHOW_PATIENT
  NO_SHOW_THERAPIST
  DISPUTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
  EXPIRED
}

enum DisputeStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  CLOSED
}

enum TherapistApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum PricingControl {
  ORGANIZATION
  THERAPIST
  BOTH
}

enum AvailabilityExceptionType {
  AVAILABLE
  BLOCKED
}

enum RaterType {
  PATIENT
  THERAPIST
}

enum AdPlacement {
  FEED
  SIDEBAR
  BANNER_TOP
  BANNER_BOTTOM
}

enum AdStatus {
  DRAFT
  ACTIVE
  PAUSED
  EXPIRED
}

model BannerAd {
  id          String        @id @default(uuid())
  title       String
  imageUrl    String
  targetUrl   String
  placement   AdPlacement
  status      AdStatus      @default(DRAFT)
  startDate   DateTime?
  endDate     DateTime?
  priority    Int           @default(0)
  createdById String
  createdBy   User          @relation(fields: [createdById], references: [id])
  analytics   AdAnalytics[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([placement, status, startDate, endDate])
}

model AdAnalytics {
  id         String   @id @default(uuid())
  bannerAdId String
  bannerAd   BannerAd @relation(fields: [bannerAdId], references: [id], onDelete: Cascade)
  type       String   // "impression" or "click"
  userId     String?
  userAgent  String?
  ip         String?
  createdAt  DateTime @default(now())

  @@index([bannerAdId, type])
  @@index([createdAt])
}

//  CASE MANAGEMENT 

model Case {
  id                 String            @id @default(cuid())
  caseNumber         String            @unique
  childId            String
  child              Child             @relation(fields: [childId], references: [id])
  primaryTherapistId String
  primaryTherapist   TherapistProfile  @relation("PrimaryTherapistCases", fields: [primaryTherapistId], references: [id])
  status             CaseStatus        @default(ACTIVE)
  openedAt           DateTime          @default(now())
  dischargedAt       DateTime?
  dischargeReason    String?
  organizationId     String?
  organization       Organization?     @relation(fields: [organizationId], references: [id])

  therapists         CaseTherapist[]
  ieps               IEP[]
  milestonePlans     MilestonePlan[]
  sessions           CaseSession[]
  documents          CaseDocument[]
  auditLogs          CaseAuditLog[]
  billingRecords     CaseBilling[]
  consents           CaseConsent[]
  treatmentPlans     TreatmentPlan[]
  sharedItems        CaseShare[]
  internalNotes      CaseInternalNote[]
  worksheets         Worksheet[]       @relation("CaseWorksheets")
  worksheetAssignments WorksheetAssignment[] @relation("CaseWorksheetAssignments")

  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt

  @@index([childId])
  @@index([primaryTherapistId])
  @@index([status])
  @@index([organizationId])
  @@map("cases")
}

model CaseTherapist {
  id          String            @id @default(cuid())
  caseId      String
  case        Case              @relation(fields: [caseId], references: [id], onDelete: Cascade)
  therapistId String
  therapist   TherapistProfile  @relation("CaseTherapistAssignments", fields: [therapistId], references: [id])
  role        CaseTherapistRole @default(SECONDARY)
  permissions Json?
  assignedAt  DateTime          @default(now())
  removedAt   DateTime?

  @@unique([caseId, therapistId])
  @@index([caseId])
  @@index([therapistId])
  @@map("case_therapists")
}

model CaseInternalNote {
  id        String   @id @default(cuid())
  caseId    String
  case      Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  authorId  String
  author    User     @relation("CaseInternalNotes", fields: [authorId], references: [id])
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([caseId])
  @@map("case_internal_notes")
}

//  IEP SYSTEM 

model IEP {
  id                    String       @id @default(cuid())
  caseId                String
  case                  Case         @relation(fields: [caseId], references: [id], onDelete: Cascade)
  version               Int          @default(1)
  status                IEPStatus    @default(DRAFT)
  templateId            String?
  template              IEPTemplate? @relation(fields: [templateId], references: [id])
  createdById           String
  createdBy             User         @relation("CreatedIEPs", fields: [createdById], references: [id])
  approvedByTherapistAt DateTime?
  approvedByParentAt    DateTime?
  reviewDate            DateTime?
  accommodations        Json?
  servicesTracking      Json?
  meetingNotes          Json?
  pdfUrl                String?

  goals                 IEPGoal[]

  previousVersionId     String?      @unique
  previousVersion       IEP?         @relation("IEPVersioning", fields: [previousVersionId], references: [id])
  nextVersion           IEP?         @relation("IEPVersioning")

  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt

  @@index([caseId])
  @@index([status])
  @@map("ieps")
}

model IEPTemplate {
  id             String        @id @default(cuid())
  name           String
  description    String?
  content        Json
  isGlobal       Boolean       @default(false)
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  createdById    String
  createdBy      User          @relation("CreatedIEPTemplates", fields: [createdById], references: [id])
  ieps           IEP[]
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([isGlobal])
  @@index([organizationId])
  @@map("iep_templates")
}

model IEPGoal {
  id                        String              @id @default(cuid())
  iepId                     String
  iep                       IEP                 @relation(fields: [iepId], references: [id], onDelete: Cascade)
  domain                    String
  goalText                  String
  targetDate                DateTime?
  baselineScreeningId       String?
  currentProgress           Float               @default(0)
  status                    GoalStatus          @default(NOT_STARTED)
  linkedScreeningIndicators Json?
  order                     Int                 @default(0)

  sessionProgress           SessionGoalProgress[]

  createdAt                 DateTime            @default(now())
  updatedAt                 DateTime            @updatedAt

  @@index([iepId])
  @@index([status])
  @@map("iep_goals")
}

model GoalBankItem {
  id             String   @id @default(cuid())
  domain         String
  condition      String?
  goalText       String
  isGlobal       Boolean  @default(false)
  organizationId String?
  createdById    String
  createdAt      DateTime @default(now())

  @@index([domain])
  @@index([isGlobal])
  @@map("goal_bank_items")
}

//  MILESTONE PLANS 

model MilestonePlan {
  id               String      @id @default(cuid())
  caseId           String
  case             Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  version          Int         @default(1)
  status           String      @default("active")
  pdfUrl           String?
  sharedWithParent Boolean     @default(false)

  milestones       Milestone[]

  previousVersionId String?    @unique
  previousVersion   MilestonePlan? @relation("MilestonePlanVersioning", fields: [previousVersionId], references: [id])
  nextVersion       MilestonePlan? @relation("MilestonePlanVersioning")

  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@index([caseId])
  @@map("milestone_plans")
}

model Milestone {
  id                String          @id @default(cuid())
  planId            String
  plan              MilestonePlan   @relation(fields: [planId], references: [id], onDelete: Cascade)
  domain            String
  description       String
  expectedAge       String?
  targetDate        DateTime?
  status            MilestoneStatus @default(ON_TRACK)
  linkedScreeningId String?
  achievedAt        DateTime?
  order             Int             @default(0)

  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  @@index([planId])
  @@index([status])
  @@map("milestones")
}

//  SESSION NOTES 

model CaseSession {
  id               String           @id @default(cuid())
  caseId           String
  case             Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  therapistId      String
  therapist        User             @relation("CaseSessionTherapist", fields: [therapistId], references: [id])
  bookingId        String?          @unique
  booking          Booking?         @relation(fields: [bookingId], references: [id])
  scheduledAt      DateTime
  actualDuration   Int?
  attendanceStatus AttendanceStatus @default(PRESENT)
  sessionType      String?
  location         String?

  rawNotes         String?
  aiSummary        String?
  noteFormat       SessionNoteFormat?
  structuredNotes  Json?

  goalProgress     SessionGoalProgress[]
  billing          CaseBilling?

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([caseId])
  @@index([therapistId])
  @@index([scheduledAt])
  @@map("case_sessions")
}

model SessionGoalProgress {
  id            String      @id @default(cuid())
  sessionId     String
  session       CaseSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  goalId        String
  goal          IEPGoal     @relation(fields: [goalId], references: [id])
  progressNote  String?
  progressValue Float?
  createdAt     DateTime    @default(now())

  @@unique([sessionId, goalId])
  @@index([sessionId])
  @@index([goalId])
  @@map("session_goal_progress")
}

//  CASE DOCUMENTS 

model CaseDocument {
  id          String           @id @default(cuid())
  caseId      String
  case        Case             @relation(fields: [caseId], references: [id], onDelete: Cascade)
  type        CaseDocumentType
  title       String
  content     String?
  fileUrl     String?
  version     Int              @default(1)
  createdById String
  createdBy   User             @relation("CaseDocuments", fields: [createdById], references: [id])

  shares      CaseShare[]

  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([caseId])
  @@index([type])
  @@map("case_documents")
}

model CaseShare {
  id           String        @id @default(cuid())
  caseId       String
  case         Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  documentId   String?
  document     CaseDocument? @relation(fields: [documentId], references: [id])
  sharedWithId String
  sharedWith   User          @relation("CaseSharedWith", fields: [sharedWithId], references: [id])
  sharedById   String
  sharedBy     User          @relation("CaseSharedBy", fields: [sharedById], references: [id])
  revokedAt    DateTime?
  createdAt    DateTime      @default(now())

  @@index([caseId])
  @@index([sharedWithId])
  @@map("case_shares")
}

//  TREATMENT PLANS 

model TreatmentPlan {
  id          String              @id @default(cuid())
  caseId      String
  case        Case                @relation(fields: [caseId], references: [id], onDelete: Cascade)
  status      TreatmentPlanStatus @default(DRAFT)
  version     Int                 @default(1)
  content     Json
  createdById String
  createdBy   User                @relation("CreatedTreatmentPlans", fields: [createdById], references: [id])
  approvedAt  DateTime?
  expiresAt   DateTime?

  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([caseId])
  @@index([status])
  @@map("treatment_plans")
}

//  CASE BILLING 

model CaseBilling {
  id          String        @id @default(cuid())
  caseId      String
  case        Case          @relation(fields: [caseId], references: [id], onDelete: Cascade)
  sessionId   String?       @unique
  session     CaseSession?  @relation(fields: [sessionId], references: [id])
  serviceCode String?
  amount      Float
  status      BillingStatus @default(PENDING)
  paidAt      DateTime?
  invoiceUrl  String?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([caseId])
  @@index([status])
  @@map("case_billing")
}

//  AUDIT LOG 

model CaseAuditLog {
  id         String   @id @default(cuid())
  caseId     String
  case       Case     @relation(fields: [caseId], references: [id], onDelete: Cascade)
  userId     String
  user       User     @relation("CaseAuditLogs", fields: [userId], references: [id])
  action     String
  entityType String
  entityId   String
  changes    Json?
  timestamp  DateTime @default(now())

  @@index([caseId])
  @@index([userId])
  @@index([timestamp])
  @@map("case_audit_logs")
}

//  CONSENT MANAGEMENT 

model CaseConsent {
  id          String      @id @default(cuid())
  caseId      String
  case        Case        @relation(fields: [caseId], references: [id], onDelete: Cascade)
  type        ConsentType
  grantedById String
  grantedBy   User        @relation("CaseConsents", fields: [grantedById], references: [id])
  validFrom   DateTime    @default(now())
  validUntil  DateTime?
  revokedAt   DateTime?
  notes       String?

  createdAt   DateTime    @default(now())

  @@index([caseId])
  @@index([type])
  @@map("case_consents")
}

//  CASE MANAGEMENT ENUMS 

enum CaseStatus {
  ACTIVE
  ON_HOLD
  DISCHARGED
  TRANSFERRED
  ARCHIVED
}

enum CaseTherapistRole {
  PRIMARY
  SECONDARY
  CONSULTANT
}

enum IEPStatus {
  DRAFT
  ACTIVE
  IN_REVIEW
  APPROVED
  ARCHIVED
}

enum GoalStatus {
  NOT_STARTED
  IN_PROGRESS
  ACHIEVED
  DISCONTINUED
}

enum MilestoneStatus {
  ON_TRACK
  EMERGING
  DELAYED
  ACHIEVED
  REGRESSED
}

enum SessionNoteFormat {
  SOAP
  DAP
  NARRATIVE
  CUSTOM
}

enum AttendanceStatus {
  PRESENT
  CANCELLED
  NO_SHOW
  LATE
}

enum CaseDocumentType {
  IEP
  REPORT
  ASSESSMENT
  SUMMARY
  PROGRESS_REPORT
  DISCHARGE_SUMMARY
  CONSENT
  OTHER
}

enum TreatmentPlanStatus {
  DRAFT
  IN_REVIEW
  APPROVED
  ACTIVE
  COMPLETED
}

enum BillingStatus {
  PENDING
  BILLED
  PAID
  OVERDUE
  CANCELLED
}

enum ConsentType {
  TREATMENT
  SHARING
  ASSESSMENT
  RECORDING
  RESEARCH
}

//  Learning Resources Enums 

enum WorksheetType {
  ACTIVITY
  VISUAL_SUPPORT
  STRUCTURED_PLAN
  PROGRESS_TRACKER
}

enum WorksheetStatus {
  DRAFT
  GENERATING
  PUBLISHED
  ARCHIVED
  FLAGGED
}

enum WorksheetColorMode {
  FULL_COLOR
  GRAYSCALE
  LINE_ART
}

enum WorksheetDifficulty {
  FOUNDATIONAL
  DEVELOPING
  STRENGTHENING
}

enum WorksheetImageStatus {
  PENDING
  GENERATING
  COMPLETED
  FAILED
}

enum WorksheetDataSource {
  MANUAL
  SCREENING
  UPLOADED_REPORT
  IEP_GOALS
  SESSION_NOTES
}

enum WorksheetAssignmentStatus {
  ASSIGNED
  VIEWED
  IN_PROGRESS
  COMPLETED
  OVERDUE
}
